# bootman

## TLDR

[byteman](https://byteman.jboss.org/) and [spring boot](https://spring.io/projects/spring-boot) colocated in same JVM, with byteman functionality exposed via REST endpoint.

`bootman =  "spring boot" + "byteman";`

## Context

Spring Boot makes it easy to create stand-alone, production-grade Spring based Java Applications that you can "just run". Byteman is a tool which injects Java code into your running application without the need for you to recompile, repackage or even redeploy your application. bootman combines these two so that you can create production grade spring applications and monitor/modify run time behavior on the fly. 

## How to Start

1. Prerequisities
    - A Java runtime Environment -> If you plan to run bootman on java 8, you should have a JDK and not a JRE. The underlying byteman framework depends on tools.jar to attach its agent to the JVM. For Java 9 and above, JRE is sufficient as the necessary agent plumbing code is present inside the JRE. However, for java 9 and above, you need to set this VM property to allow the agent to attach itself to the same VM:\
    `-Djdk.attach.allowAttachSelf=true` 
    - git to clone the bootman codebase locally
2. Go to your favorite terminal and clone the bootman repository inside a local folder\
    ```git clone https://github.com/rajasenapati/bootman.git```
3. Build and run bootman.
   bootman can be executed as a standalone springboot based executable fat jar. It can also be executed in its expanded form. 
    ```
    # approach 1: run bootman in expanded form (works for java 8 and above)
    cd bootman
    ./mvnw clean
    ./mvnw spring-boot:run
   
    # approach 2: run bootman as a spring boot executable fat jar (for java 8)
    cd bootman
    ./mvnw clean
    ./mvnw install
    java -Dloader.path=$JAVA_HOME/lib/tools.jar -jar target/bootman-0.0.1-SNAPSHOT.jar

    # approach 3: run bootman as a spring boot executable fat jar (for java 9 and above)
    cd bootman
    ./mvnw clean
    ./mvnw install
    java -Djdk.attach.allowAttachSelf=true -jar target/bootman-0.0.1-SNAPSHOT.jar   
    ```
4. This will run the bootman application server on port 8080. You can terminate the server instance anytime by pressing CTRL+C in the same terminal or by killing it by its pid from another terminal.
5. Open the [swagger page](http://localhost:8080/swagger-ui.html) in your favorite browser window. 
    ![swagger](https://github.com/rajasenapati/bootman/blob/media/swagger.png?raw=true)
    bootman comes with three sets of API -
    - **byteman management API** : attach to the running VM and then install/reinstall/uninstall rules to modify application behavior as needed. A sample [byteman rule file](https://github.com/rajasenapati/bootman/blob/master/src/main/resources/sample_rules/webdemo.btm) is part of this repository. This will be used subsequently to showcase bootman features in the later part of the document.
    - **application API** : a sample endpoint is implemented to demonstrate bootman code injection in action. Replace this with your own application specific logic.
    - **basic error API**: basic error management API autogenerated by spring boot. You can customize it or completely remove it. bootman does not care about it.
6. Run the sample endpoint first. You will see an output like this:
    ![uninstrumented application code](https://github.com/rajasenapati/bootman/blob/media/greet_before_instrument.png?raw=true) 

   And the following entry in the application log.
   ```
   2020-01-04 20:19:30.587  INFO 64827 --- [nio-8080-exec-9] o.j.bootman.controller.HelloController   : just a harmless but useless log statement. I wish the name parameter were logged here.
   ```

   The underlying application code for above Rest endpoint is
   ``` java
   @RestController
    @Api(value="/greet", tags={"Sample Endpoint API"}, produces ="application/json")

    @RequestMapping("/greet")
    public class HelloController {
        private static final Logger logger = LoggerFactory.getLogger(HelloController.class);

        @RequestMapping(value="/{name}",method= RequestMethod.GET)
        public String sayHello(@PathVariable String name) {
            logger.info("just a harmless but useless log statement. I wish the name parameter were logged here.");
            String message = "hello " + name;
            return message;
        }
    }
   ``` 
   Notice that the application does not log the parameter `name` it receives from the client request. Imagine you are in production and you have to troubleshoot the above code. I do not know about you. But if it were me, I would definitely like to see the `name` parameter this method receives from the client code without changing the code, rebuilding the app and redeploying it. Also I might want to use a different logic to calculate the variable `message` which is ultimately sent back to the calling client. With bootman, you can do that. Lets see how this works.

 7. First activate the agent  
    ![activate agent](https://github.com/rajasenapati/bootman/blob/media/activateAgent.png?raw=true)
    While activating the agent, you can optionally pass [additional properties/Environment Settings](https://downloads.jboss.org/byteman/4.0.9/byteman-programmers-guide.html#environment-settings) to the agent. By default, we pass `org.jboss.byteman.verbose` property to enable verbose logging. With verbose mode enabled, you will see following entry in the application log:
    ```
    for java 8: 
    ===========
    Setting org.jboss.byteman.verbose=
    AccessManager:init Initialising default AccessManager
    TransformListener() : accepting requests on localhost:9091

    for java 9 and above:
    =====================
    Setting org.jboss.byteman.verbose=
    AccessManager:init Initialising JDK9 AccessManager
    AccessManager:init created module
    AccessManager:init added extraReads
    AccessManager:init returning JigsawAccessEnabler
    TransformListener() : accepting requests on localhost:9091
    ```

8. Install the Rules to inject the new code behavior.
   Grab the rules from [here](https://github.com/rajasenapati/bootman/blob/master/src/main/resources/sample_rules/webdemo.btm) and paste it in following swagger call.
   ![add Rules](https://github.com/rajasenapati/bootman/blob/media/addRules.png?raw=true)
   You will see following response:
   ```
    install rule trace HelloController entry
    install rule trace exit
    install rule modify values
   ```

   Also the application log will have entries similar to what is shown below:
   ```
    TransformListener() : handling connection on port 9091
    retransforming org.javaprofile.bootman.controller.HelloController
    org.jboss.byteman.agent.Transformer : possible trigger for rule trace HelloController entry in class org.javaprofile.bootman.controller.HelloController
    RuleTriggerMethodAdapter.injectTriggerPoint : inserting trigger into org.javaprofile.bootman.controller.HelloController.sayHello(java.lang.String) java.lang.String for rule trace HelloController entry
    org.jboss.byteman.agent.Transformer : inserted trigger for trace HelloController entry in class org.javaprofile.bootman.controller.HelloController
    org.jboss.byteman.agent.Transformer : possible trigger for rule trace exit in class org.javaprofile.bootman.controller.HelloController
    RuleTriggerMethodAdapter.injectTriggerPoint : inserting trigger into org.javaprofile.bootman.controller.HelloController.sayHello(java.lang.String) java.lang.String for rule trace exit
    org.jboss.byteman.agent.Transformer : inserted trigger for trace exit in class org.javaprofile.bootman.controller.HelloController
    org.jboss.byteman.agent.Transformer : possible trigger for rule modify values in class org.javaprofile.bootman.controller.HelloController
    RuleTriggerMethodAdapter.injectTriggerPoint : inserting trigger into org.javaprofile.bootman.controller.HelloController.sayHello(java.lang.String) java.lang.String for rule modify values
    org.jboss.byteman.agent.Transformer : inserted trigger for modify values in class org.javaprofile.bootman.controller.HelloController
    2020-01-04 20:50:28.771  INFO 64827 --- [nio-8080-exec-3] o.j.b.controller.BytemanController       : Now deleting the rule file: /tmp/rule3592669835277761411.btm
   ```
9. Verify that the rules have been installed properly
    ![list all Rules](https://github.com/rajasenapati/bootman/blob/media/listAllRules.png?raw=true)
10. Now run the application API again
    ![instrumented application code](https://github.com/rajasenapati/bootman/blob/media/greet_after_instrument.png?raw=true)
    You will notice two differences
     - The response has now changed from `hello Joe` to  `Byteman: hello Joe`
     - Also the application log now captures the parameter `name` passed from the calling client
    ```
    2020-01-04 21:37:26.910  INFO 64827 --- [nio-8080-exec-9] o.j.bootman.controller.HelloController   : controller parameter as captured by byteman -->Joe
    2020-01-04 21:37:26.910  INFO 64827 --- [nio-8080-exec-9] o.j.bootman.controller.HelloController   : message before modification by byteman -->hello Joe
    2020-01-04 21:37:26.910  INFO 64827 --- [nio-8080-exec-9] o.j.bootman.controller.HelloController   : message after modification by byteman -->Byteman: hello Joe
    Rule.execute called for trace exit_1:0
    HelperManager.install for helper class org.jboss.byteman.rule.helper.Helper
    calling installed(trace exit) for helper classorg.jboss.byteman.rule.helper.Helper
    Installed rule using default helper : trace exit
    trace exit execute
    2020-01-04 21:37:26.911  INFO 64827 --- [nio-8080-exec-9] o.j.bootman.controller.HelloController   : exiting sayHello
    ```
    This is due to the installed rules which injected the new behavior. [Here](https://downloads.jboss.org/byteman/4.0.9/byteman-programmers-guide.html) you can get to know more about byteman capabilities. 

11. Time to cleanup now. Delete the rules previously installed.
    ![delete all Rules](https://github.com/rajasenapati/bootman/blob/media/deleteAllRules.png?raw=true)

12. And verify we are back to square one.
    ![application code post rule cleanup](https://github.com/rajasenapati/bootman/blob/media/greet_after_rule_deletions.png?raw=true)

13. And that's it. Feel free to modify the codebase to suit your needs.
